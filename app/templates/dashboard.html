<!-- app/templates/dashboard.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container mt-5">
  <div class="d-flex justify-content-between mb-3">
    <h2>Dashboard</h2>
    <button class="btn btn-danger" id="logoutBtn">Logout</button>
  </div>
  <div id="welcome"></div>
</div>

<script>
async function refreshToken() {
  const refresh_token = localStorage.getItem('refresh_token');
  if (!refresh_token) return window.location.href = '/login';

  const res = await fetch('/api/auth/refresh', {
    method: 'POST',
    headers: {'Authorization': 'Bearer ' + refresh_token}
  });
  if (res.ok) {
    const data = await res.json();
    localStorage.setItem('access_token', data.access_token);
  } else {
    localStorage.clear();
    window.location.href = '/login';
  }
}

// ต่ออายุ token ทุก 5 นาที
setInterval(refreshToken, 5 * 60 * 1000);

async function loadDashboard() {
  const token = localStorage.getItem('access_token');
  if (!token) return window.location.href = '/login';

  const res = await fetch('/api/user/me', {
    headers: {'Authorization': 'Bearer ' + token}
  });
  if (!res.ok) return window.location.href = '/login';
  const data = await res.json();
  document.getElementById('welcome').innerText = 'Welcome, ' + data.username;
}


document.getElementById('logoutBtn').addEventListener('click', async () => {
  const token = localStorage.getItem('access_token');
  await fetch('/api/auth/logout', {
    method: 'POST',
    headers: {'Authorization': 'Bearer ' + token}
  });
  localStorage.clear();
  window.location.href = '/login';
});

loadDashboard();
</script>
</body>
</html>
